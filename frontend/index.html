<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>File Upload</title>
    <!-- Bootstrap CSS (for styling) -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f4f7fc;
        font-family: "Roboto", sans-serif;
      }
      .container {
        max-width: 750px;
        margin: 50px auto;
        padding: 40px;
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.05);
      }
      h2 {
        font-size: 2rem;
        text-align: center;
        margin-bottom: 30px;
        color: #333;
        font-weight: 600;
      }
      .form-label {
        font-size: 1.1rem;
        font-weight: 500;
        color: #555;
      }
      .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
        transition: background-color 0.3s ease-in-out;
        padding: 10px;
        font-size: 1.1rem;
      }
      .btn-primary:hover {
        background-color: #0056b3;
        border-color: #004494;
      }
      .btn-secondary {
        background-color: #6c757d;
        border-color: #6c757d;
        margin-top: 15px;
        width: 100%;
        padding: 10px;
        font-size: 1.1rem;
      }
      .btn-secondary:hover {
        background-color: #565e64;
      }
      .text-success {
        font-weight: bold;
        color: #28a745;
      }
      .text-danger {
        font-weight: bold;
        color: #dc3545;
      }
      #result {
        margin-top: 20px;
      }
      .nav-tabs {
        border-bottom: 2px solid #dee2e6;
      }
      .nav-link {
        border: none;
        border-radius: 0;
        font-size: 1.1rem;
        font-weight: 500;
        color: #555;
      }
      .nav-link.active {
        color: #007bff;
        border-bottom: 3px solid #007bff;
        background-color: transparent;
      }
      .table-container {
        margin-top: 30px;
      }
      .table {
        margin-top: 30px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        border-radius: 8px;
        overflow: hidden;
      }
      .table th,
      .table td {
        vertical-align: middle;
        padding: 15px;
        font-size: 1rem;
      }
      .table-striped tbody tr:nth-of-type(odd) {
        background-color: #f9f9f9;
      }
      .btn-sm {
        padding: 8px 12px;
        font-size: 0.9rem;
        border-radius: 4px;
      }
      .table-dark {
        background-color: #343a40;
        color: #fff;
      }
      /* Styles for the search input */
      #searchInput {
        margin-top: 20px;
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 5px;
        width: 100%;
        border: 1px solid #ced4da;
        font-size: 1rem;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>File Upload & Management</h2>

      <!-- Nav tabs -->
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="upload-tab"
            data-bs-toggle="tab"
            data-bs-target="#upload"
            type="button"
            role="tab"
            aria-controls="upload"
            aria-selected="true"
          >
            Upload
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="uploads-tab"
            data-bs-toggle="tab"
            data-bs-target="#uploads"
            type="button"
            role="tab"
            aria-controls="uploads"
            aria-selected="false"
          >
            Uploaded Files
          </button>
        </li>
      </ul>

      <!-- Tab content -->
      <div class="tab-content" id="myTabContent">
        <!-- Upload Form Tab -->
        <div
          class="tab-pane fade show active"
          id="upload"
          role="tabpanel"
          aria-labelledby="upload-tab"
        >
          <form id="uploadForm" class="mt-4">
            <div class="mb-3">
              <label for="fileInput" class="form-label">Choose File</label>
              <input
                type="file"
                class="form-control"
                id="fileInput"
                name="file"
              />
            </div>
            <button type="submit" class="btn btn-primary w-100">Upload</button>
          </form>
          <div id="result" class="mt-3"></div>
        </div>

        <!-- Uploaded Files Tab -->
        <div
          class="tab-pane fade"
          id="uploads"
          role="tabpanel"
          aria-labelledby="uploads-tab"
        >
          <!-- Search box for filtering files -->
          <input
            type="text"
            id="searchInput"
            placeholder="Search files..."
            onkeyup="filterFiles()"
          />
          <div id="uploadedFiles" class="table-container table-responsive">
            <table class="table table-striped table-bordered">
              <thead class="table-dark">
                <tr>
                  <th>#</th>
                  <th>File Name</th>
                  <th>Download</th>
                </tr>
              </thead>
              <tbody id="fileTableBody">
                <!-- File rows will be populated dynamically here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- JavaScript for handling the file upload and fetching uploaded files -->
    <script>
      const uploadForm = document.getElementById("uploadForm");
      const resultDiv = document.getElementById("result");
      const fileTableBody = document.getElementById("fileTableBody");
      const searchInput = document.getElementById("searchInput");

      // Function to handle file upload
      uploadForm.addEventListener("submit", async function (event) {
        event.preventDefault();

        const fileInput = document.getElementById("fileInput").files[0];
        if (!fileInput) {
          resultDiv.innerHTML =
            '<p class="text-danger">Please choose a file to upload.</p>';
          return;
        }

        const formData = new FormData();
        formData.append("file", fileInput);

        try {
          const response = await fetch("http://localhost:8001/upload/", {
            method: "POST",
            body: formData,
          });

          const result = await response.json();

          if (response.ok) {
            resultDiv.innerHTML = `<p class="text-success">Upload successful: ${result.message}</p>`;
            fetchUploadedFiles(); // Fetch and display uploaded files after successful upload
          } else {
            resultDiv.innerHTML = `<p class="text-danger">Error: ${result.detail}</p>`;
          }
        } catch (error) {
          resultDiv.innerHTML = `<p class="text-danger">An error occurred while uploading the file: ${error.message}</p>`;
        }
      });

      // Function to fetch and display uploaded files
      async function fetchUploadedFiles() {
        try {
          const response = await fetch("http://localhost:8001/uploads");
          const files = await response.json();

          // Clear the current table body
          fileTableBody.innerHTML = "";

          // Assuming files is the list of filenames retrieved from the server
          files.forEach((file, index) => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${index + 1}</td>
              <td>${file}</td>
              <td><a href="http://localhost:8003/download/${file}" class="btn btn-success btn-sm">Download</a></td>
            `;
            fileTableBody.appendChild(row);
          });
        } catch (error) {
          console.error("Error fetching uploaded files:", error);
        }
      }

      // Function to filter files based on search input
      function filterFiles() {
        const filter = searchInput.value.toLowerCase();
        const rows = fileTableBody.getElementsByTagName("tr");

        Array.from(rows).forEach((row) => {
          const fileName = row.getElementsByTagName("td")[1].textContent;
          if (fileName.toLowerCase().includes(filter)) {
            row.style.display = "";
          } else {
            row.style.display = "none";
          }
        });
      }

      // Fetch uploaded files on page load
      fetchUploadedFiles();
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
